

props and params with lists of values use ,

properties with multiple parts (as opposed to a list of values), use ;

property params with values containg ":", ",", or ";" must be placed in quoted text

property param values cannot contain '"'

property param values not in quoted strings are case insensitive...

two forms of mult-valued properties:

"," seperated values of a single property

new content line for each value


API should perhaps hide this difference? Also, some properties docs prefer
one or the other of the forms.


All iCal parameters are documented in RFC2445s4.2. Variations:

param-value

DQUOTE value DQUOTE *( "," DQUOTE value DQUOTE )

List of case-insensitive token: "ACCEPTED", .., x-name, iana-token

paramtext

Some have refererences to property value types.


value parameter must be speced if property value is not of the default type
for that property.

Not too long a list of property value types, see RFC2445s4.3:

"BINARY"
/ "BOOLEAN"
/ "CAL-ADDRESS"
/ "DATE"
/ "DATE-TIME"
/ "DURATION"
/ "FLOAT"
/ "INTEGER"
/ "PERIOD"
/ "RECUR"
/ "TEXT"
/ "TIME"
/ "URI"
/ "UTC-OFFSET"


Components and their allowed/required/etc. properties are described in RFC2445s4.6.

Values and semantics of property values are in 4.7 and 4.8.

Allowed property values can vary depending on the calendar component they are
used within, or at least STATUS can.

Property spec includes expect value type, as well as allowed parameters.


Also, there are inter-related "hooks" for propetries, such as the list of
properties that cause the SEQUENCE property to be incrmented whenever one of
those properties are changed.


Should be able to parse the examples in s5.


Data structures:

component =>
list of allowed properties


property=>
list of allowed parameters
restrictions on allowed parameter values?

default value type
other allowed value types?
multiplicity of value
restrictions on allowed value type?

parameter=>
decoding function
encoding function

value type=>
decoding function
encoding function


APIs:

Vpim
Icalendar
Rrule
		Attendee
		Attachment
		...?

		Vevent
		Vtodo
		V...

		Property
		  Common (summary/description/...)
			Times (dtstart/dtend/duration)
			...

			Divide into groups, if possible, if the entire group is implemented together.
		  


Rrule

Shouldn't this be under Icalendar?

Also, I think it needs to take DTEND and/or DURATION as an arg, or in Vevent,
both #dtend and #duration need to take an optional +ytime+, so you can find
the how long each occurence is.

Icalendar#
prodid
n: 1
#value   TEXT

version
n: 1
#value   "2.0"

calscale
n:0-1
#value   "GREGORIAN"


method
n:0-1
#value   ... see iTIP

components...
#event
#todo
#journal
#freebusy
#timezone
#iana...
#x...


Vevent#

#properties  --> a Dirinfo?

#class
n:0-1
#value    "PUBLIC" / "PRIVATE" / "CONFIDENTIAL" / ...
(default is "PUBLIC")

#created
n:0-1
#value    DATE-TIME, must be UTC
(default is "PUBLIC")

#dtstamp
n:0-1
#value   DATE-TIME, must be UTC

#last-modified
n:0-1
#value    DATE-TIME, must be UTC

#dtstart, #dtend, 
n:0-1
#value    DATE-TIME, or optionally DATE
param VALUE
param TZID supported?
		  (dtstart is required for VEVENT, different criteria by component)

#duration
n:0-1
#value    special format... currently return seconds, but that is only
with respect to the specific occurence. Perhaps it should take an
arg, where it's arg is start time. Default is DTSTART, but if you
want to know the duration of each occurence, you can ask with the
new start time. Or does Rrule already handle this?

note: either DTEND or DURATION, but not both

#description/#location/#summary
n:0-1
#value    TEXT
param ALTREP
param LANGUAGE

Deal with altrep by having #description_altrep, etc, returning a URI

#geo
n:0-1
#value   [ FLOAT, FLOAT ], the latitude and longitude

#organizer
n:0-1
#value    CAL-ADDRESS
param CN
param DIR
param SENTBY
param LANGUAGE

#priority
n:0-1
#value   INTEGER, range is 0-9, 0 being unspecified (the default), 1 being highest priority

#sequence
n:0-1
#value   INTEGER

#status
n:0-1
#value   "TENTATIVE"/ "CONFIRMED"/ "CANCELLED" (different for each component)

#transp
n:0-1
#value   "OPAQUE" / "TRANSPARENT"

#uid
n:0-1
#value    TEXT

#url
n:0-1
#value    URI, return as text? probably easiest... maybe accept URI though, particularly
if it has a to_str or to_s method

#recurid
n:0-1
#value    DATE-TIME, or optionally DATE
param VALUE
param TZID supported?
param RANGE

Should be a class, and it has tons of special handling... deal with later
if I ever do iTIP.

#attachments
	  n:0-*
		... array of class Attachment
		  Attachement
			  #uri          TEXT  (default)
				#binary       String, ENCODING=BASE64, VALUE=BINARY
				#format       param FMTTYPE, application/x-word, etc., default to "" or nil?
				#value        either binary, or download the URI, can it be a StringIO?

#attendees
	  n:0-*
		... array of class Address

	#categories
	  n:0-*
		#value   TEXT
		... array of String
		param LANGUAGE ... don't support

		(Concatenate all the categories found, comma seperated in each value, all
		the property values in one array)

	#resources
	  n:0-*
		#value   TEXT
		... array of String
		param LANGUAGE ... don't support
		param ALTREP ... don't support

		(Concatenate all the resources found, comma seperated in each value, all
		the property values in one array)

	#comments
	  n:0-*
		#value   TEXT
		... array of String
		param LANGUAGE ... don't support
		param ALTREP ... don't support

		(Concatenate all the comments found, all the property values in one array)

#contacts
	  n:0-*
	  #value   TEXT
		... array of String
		param LANGUAGE ... don't support
		param ALTREP ... don't support

#exrules
	  n:0-*
		#value   RRULE
		... array of Rrule

#exdates
	  n:0-*
		#value   DATE-TIME, or optionally DATE
		... array of Time, or Date?
param VALUE
param TZID supported?

#rstatus
	  n:0-*
		#value   TEXT, kindof
		... array of class Status:
		             #code
								 #description
								 #extra

#relationships "RELATED-TO"
	  n:0-*
		#value   TEXT
		... array of class Related:
		  #uid     String
			#type    "PARENT"/ "CHILD" / "SIBLING" (parent is default)
			#target  ... a component?

		could use special handing:

		#parents  (default)
		#children
		#siblings

		  --> type should be components, that I look up by UID

#rrule
	#rdate
	  ... both may occur multiple times, how to handle? I think
		I need a #recurrences that returns an object that has all the
		rrules, rdates, and exceptional conditions in it, and returns
		them in sorted order....

		Not trivial! Definitely could use some test code.


; the following are optional, ; and MAY occur more than once
	x-prop
	 
	 Give access to the underlying fields if they want to do something special.

	
For multi-valued properties where it might be useful to have access to the
params, sometime, I could do #comments(detailed=false) where detailed returns
objects if its needed. In the meantime, there's always the dirinfo APIs.


alarms...
n:0-*
		... array of Alarm:

		  TBD...



Summary of properties by component type:

can have *alarmc:

	vevent
	vtodo


              Vtodo:        Vevent:       Vjournal:

the following are optional, but MUST NOT occur more than once

class         x             x             x
created       x             x             x
description   x             x             x
dtstamp       x             x             x
dtstart       x             x             x
last-mod      x             x             x
organizer     x             x             x
recurid       x             x             x
seq           x             x             x
status        x             x             x
summary       x             x             x
uid           x             x             x
url           x             x             x

completed     x
geo           x             x
location      x             x
percent       x
priority      x             x
transp                      x

the following are optional, and MAY occur more than once

attach        x             x             x
attendee      x             x             x
categories    x             x             x
comment       x             x             x
contact       x             x             x
exdate        x             x             x
exrule        x             x             x
rdate         x             x             x
related       x             x             x
resources     x             x
rrule         x             x             x
rstatus       x             x             x


Notes:

Vtodo - either 'due' or 'duration' may appear in a 'todoprop', but 'due' and
'duration'
MUST NOT occur in the same 'todoprop'

	due
	duration



Vevent - either 'dtend' or 'duration' may appear in a 'eventprop', but 'dtend'
and 'duration' MUST NOT occur in the same 'eventprop'

	dtend
	duration



=begin

  ...            ; y/n    (whether I've seen it in Apple's calendars)
                   name
                   section
                   type/comments


  icalbody = icalprops component

  icalprops =
     prodid /    ; y  PRODID    4.7.3  required, TEXT
     version /   ; y            4.7.4  required, TEXT, "2.0"
     calscal /   ; y            4.7.1  only defined value is GREGORIAN
     method /    ; n  METHOD    4.7.2  used with transport protocols

  component =
     eventc /    ; y  VEVENT    4.6.1
     todoc /     ; y  VTODO     4.6.2
     journalc /  ; n
     freebusyc / ; n
     timezonec / ; n
     
   alarmc        ; y  VALARM  4.6.6  occurs inside a VEVENT or a VTODO

   class         ; y  CLASS     4.8.1.3   private/public/confidentical/... (default=public)

   comment       ; n            4.8.1.4   TEXT
   description   ; y            4.8.1.5   TEXT
   summary       ; y            4.8.1.12  TEXT
   location      ; y            4.8.1.7   TEXT  intended venue
 
   priority      ; n why?       4.8.1.9   INTEGER, why isn't this seen for my TODO items?

   status        ; y            4.8.1.11  TEXT, different values defined for event, todo, journal

      Event: TENTATIVE, CONFIRMED, CANCELLED

      Todo: NEEDS-ACTION, COMPLETED, IN-PROCESS, CANCELLED

      Journal: DRAFT, FINAL, CANCELLED

   dtstart       ; y  DTSTART   4.8.2.4   DATE-TIME is default, value=date can be set
   dtend         ; y  DTEND     4.8.2.2   Unless it has Z (UTC), or a tzid, then it is local-time.

   dtstamp       ; y  DTSTAMP   4.8.7.2   DATE-TIME, creation time, inclusion is mandatory, but what does
     it mean? It seems to be when the icalendar was actually created (as opposed to when the user entered
     the information into the calendar database, for example), but in that case my Apple icalendars should
     have all components having the same DTSTAMP, but they don't!

   duration      ; y  DURATION  4.8.2.5   dur-value

     dur-value  = (["+"] / "-") "P" (dur-date / dur-time / dur-week)

     dur-date   = dur-day [dur-time]
                = 1*DIGIT "D" [ dur-time ]
                
     dur-time   = "T" (dur-hour / dur-minute / dur-second)
                = "T" (
                    1*DIGIT "H" [ 1*DIGIT "M" [ 1*DIGIT "S" ] ] /
                                  1*DIGIT "M" [ 1*DIGIT "S" ]   /
                                                1*DIGIT "S"
                    )

     dur-week   = 1*DIGIT "W"
     dur-day    = 1*DIGIT "D"
     dur-hour   = 1*DIGIT "H" [dur-minute]
     dur-minute = 1*DIGIT "M" [dur-second]
     dur-second = 1*DIGIT "S"

     The EBNF is complicated, because they want to say that /some/ component
     must be present, and that if you have a "T", you need a time after it,
     and that you can't have an hour followed by seconds with no intervening
     minutes... but we don't care about that during decoding, so we rewrite
     the EBNF as:

     dur-value = ["+" / "-"] "P" [ 1*DIGIT "W" ] [ 1*DIGIT "D" ] [ "T" [ 1*DIGIT "H" ]  [ 1*DIGIT "M" ] [ 1*DIGIT "S" ] ]

   dtdue         ; n  DTDUE     4.8.2.3

   uid           ; y  UID       4.8.4.7   TEXT, recommended to generate them in RFC822 form

   rrule         ; y  RRULE     4.8.5.4   RECUR, can occur multiple times!

   

VEVENT Ifx:

  TEXT: summary, description, comment, location, uid

  think about:  uid

  Vevent#status -> The status, upper-case.
  Vevent#status= -> set a new status, only allow the defined statuses!
  Vevent#status?(s) -> check if the status is s

  can contain alarms... should it include an alarms module?

=end

